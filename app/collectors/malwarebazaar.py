from __future__ import annotations
import os
import requests
from typing import List
from app.models import IOC, now_iso
from app.collectors.base import Collector
import app.config

class MalwareBazaarRecentCollector(Collector):
    name = "malwarebazaar_recent"

    def __init__(self) -> None:
        self.api_key = os.environ.get("MALWAREBAZAAR_API_KEY", app.config.mlw_api_key).strip()
        self.endpoint = "https://mb-api.abuse.ch/api/v1/"

    def fetch(self) -> List[IOC]:
        if not self.api_key:
            print("[malwarebazaar_recent] falta MALWAREBAZAAR_API_KEY en entorno")
            return []

        payload = {"query": "get_recent", "selector": "time"}

        # Cabeceras compatibles (algunas instalaciones exigen Auth-Key)
        headers = {
            "Auth-Key": self.api_key,
            "API-KEY": self.api_key,
            "User-Agent": "intel_ingest/1.0 intel by h3st4k3r)",
        }

        r = requests.post(self.endpoint, data=payload, headers=headers, timeout=30)
        r.raise_for_status()
        data = r.json()

        out: List[IOC] = []
        collected = now_iso()

        for e in data.get("data", []) or []:
            sha256 = e.get("sha256_hash")
            if not sha256:
                continue
            title = f"Malware sample {sha256[:12]}"
            out.append(
                IOC(
                    kind="ioc",
                    source=self.name,
                    source_id=sha256,
                    title=title,
                    url=e.get("url") or None,
                    published_at=e.get("first_seen"),
                    collected_at=collected,
                    raw=e,
                    indicator=sha256,
                    ioc_type="sha256",
                )
            )
        return out
